<div class="cell">
  <div class="bd">

    <div class="weui-cells__title">请拍几张照片，并提交商品描述</div>
    <div class="weui-cells">
      <div class="weui-cell">
        <div class="weui-cell__bd">
          <div class="weui-uploader">
            <div class="weui-uploader__bd">
              <ul class="weui-uploader__files">
              </ul>
              <div class="weui-uploader__input-box">
                <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple="">
                </div>
            </div>
          </div>
        </div>
      </div>
      <div class="weui-cell">
        <div class="weui-cell__bd">
          <textarea id="product_name" class="weui-textarea ydw_font_small" placeholder="标题" rows="1"></textarea>
        </div>
      </div>
      <div class="weui-cell">
        <div class="weui-cell__bd">
          <textarea id="product_desc" class="weui-textarea ydw_font_small" placeholder="详细说明" rows="4"></textarea>
        </div>
      </div>
      <div class="weui-cell">
        <div class="weui-cell_hd"><label class="weui-label">希望价格(元)</label></div>
        <div class="weui-cell__bd">
          <input id="price" class="weui-input" style="text-align: right; " type="number" placeholder="请输入希望价格" value="0">
        </div>
      </div>
    </div>

  <div class="weui-msg__opr-area">
    <p class="weui-btn-area">
        <button href="javascript:;" id="btn_submit" class="weui-btn weui-btn_disabled weui-btn_primary">发布</button>
      </p>
    </div>
  </div>
</div>

<!--Locate_nav end-->
{{#extend "scripts"}}
<script>
 jsApilist = jsApilist.concat([
     'chooseImage',
     'uploadImage',
     'previewImage'
 ]);
 var previewUrls = [];
 $(function () {
     $('#btn_submit')
         .prop('disabled', true)
         .addClass('weui-btn_disabled');

     $("#product_name,#product_desc,#price").keyup(function() {
         if($('#product_name').val().length >= 10 &&
            $('#product_desc').val().length >= 10 &&
            $('#price').val().length >= 1) {
             $('#btn_submit').prop('disabled', false).removeClass('weui-btn_disabled');
         } else {
             $('#btn_submit').prop('disabled', true).addClass('weui-btn_disabled');
         }
     });

     $('#btn_submit').click(function () {
         $.showLoading('数据提交中');
         $.ajax({
             url: '/product/new',
             type: 'post',
             data: {
                 seller: '{{req.session.user._id}}',
                 product_detail: {
                     product_name: $('#product_name').val(),
                     price: $('#price').val(),
                     product_desc: $('#product_desc').val(),
                     images: previewUrls
                 }
             }
         }).done(function(res) {
             $.hideLoading();
             $.toast('数据上传完毕。', function() {
                 window.location = '/product/' + res.product._id;
             });
         });

     });
     $('.weui-uploader__input').click(function () {
         wx_upload('/product/upload', function(data) {
             if(data.success){
                 previewUrls.push(data.image);
                 var insertHtml = '<li class=\"weui-uploader__file\" style=\"background-image:url(' + data.image + ')\" onclick=\"javascript:previewImage(\'' + data.image + '\');\"></li>';
                 $('.weui-uploader__files').append(insertHtml);
             } else {
                 $.toast('图片上载出错啦', 'forbidden');
             }
         });
     });

 });
 function previewImage(url) {
     wx.previewImage({
         current: url,
         urls: previewUrls
     });
 };

</script>
{{/extend}}
